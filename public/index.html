<!DOCTYPE html>
<html lang="pt-BR" class="h-full bg-gray-100">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portal de Romaneios</title>

    <!-- PWA Manifest -->
    <link rel="manifest" href="/manifest.json">

    <!-- Styles and Fonts -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Inter', sans-serif; }
        .hidden { display: none; }
        summary {
            cursor: pointer;
            outline: none;
        }
        summary::marker, summary::-webkit-details-marker {
            content: '';
            display: none;
        }
    </style>
</head>
<body class="h-full bg-gray-50">

    <div id="app-container" class="w-full max-w-4xl mx-auto p-4 sm:p-6 lg:p-8">
        
        <!-- Tela de Login -->
        <div id="login-screen">
            <div class="max-w-md mx-auto">
                <img class="mx-auto h-24 w-auto rounded-full" src="logo frg.jpeg" alt="Logo Frigorífico">
                <h2 class="mt-6 text-center text-3xl font-bold tracking-tight text-gray-900">Acesso ao Portal de Romaneios</h2>
            </div>
            <form id="login-form" class="mt-8 space-y-6 max-w-md mx-auto" action="#" method="POST">
                <div class="rounded-md shadow-sm -space-y-px">
                    <div>
                        <label for="username" class="sr-only">Usuário ou E-mail</label>
                        <input id="username" name="username" type="text" required class="relative block w-full appearance-none rounded-none rounded-t-md border border-gray-300 px-3 py-3 text-gray-900 placeholder-gray-500 focus:z-10 focus:border-indigo-500 focus:outline-none focus:ring-indigo-500 sm:text-sm" placeholder="Usuário ou E-mail">
                    </div>
                    <div>
                        <label for="password" class="sr-only">Senha</label>
                        <input id="password" name="password" type="password" autocomplete="current-password" required class="relative block w-full appearance-none rounded-none rounded-b-md border border-gray-300 px-3 py-3 text-gray-900 placeholder-gray-500 focus:z-10 focus:border-indigo-500 focus:outline-none focus:ring-indigo-500 sm:text-sm" placeholder="Senha">
                    </div>
                </div>

                <div id="error-message" class="text-red-600 text-sm text-center hidden"></div>

                <div>
                    <button type="submit" class="group relative flex w-full justify-center rounded-md border border-transparent bg-indigo-600 py-3 px-4 text-sm font-medium text-white hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2">
                        Entrar
                    </button>
                </div>
            </form>
            <div class="mt-4 text-center">
                <a href="#" id="forgot-password-link" class="font-medium text-indigo-600 hover:text-indigo-500">Esqueci a senha</a>
            </div>
        </div>

        <!-- Tela do Dashboard (Arquivos) -->
        <div id="dashboard-screen" class="hidden">
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4">
                <div class="flex items-center space-x-4">
                    <img class="h-14 w-14 rounded-full" src="logo frg.jpeg" alt="Logo Frigorífico">
                    <div>
                        <h2 class="text-2xl font-bold text-gray-900">Seus Romaneios</h2>
                        <p id="welcome-message" class="text-gray-600">Bem-vindo(a)!</p>
                    </div>
                </div>
                <div class="flex items-center space-x-2 w-full sm:w-auto">
                    <button id="back-button" class="flex-1 sm:flex-none rounded-md bg-gray-600 px-4 py-2 text-sm font-medium text-white hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2">
                        Voltar
                    </button>
                    <button id="logout-button" class="flex-1 sm:flex-none rounded-md bg-red-600 px-4 py-2 text-sm font-medium text-white hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2">
                        Sair
                    </button>
                </div>
            </div>
            
            <div id="loading-indicator" class="text-center py-10">
                <p class="text-gray-500">Carregando seus arquivos...</p>
            </div>

            <div id="file-groups-container" class="bg-white shadow overflow-hidden sm:rounded-md">
                <!-- Pastas e arquivos serão inseridos aqui -->
            </div>
            <div id="no-files-message" class="text-center py-10 px-4 hidden">
                <p class="text-gray-500">Nenhum arquivo encontrado para você.</p>
            </div>
        </div>
    </div>

    <!-- Modal de Redefinição de Senha -->
    <div id="reset-password-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-sm">
            <h3 class="text-lg font-medium leading-6 text-gray-900">Redefinir Senha</h3>
            <p class="mt-2 text-sm text-gray-500">Digite seu e-mail ou nome de usuário para receber o link de redefinição.</p>
            <form id="reset-password-form" class="mt-4">
                <div>
                    <label for="reset-email" class="sr-only">E-mail ou Usuário</label>
                    <input type="text" name="reset-email" id="reset-email" class="block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" placeholder="seu.usuario ou seu@email.com" required>
                </div>
                <div id="reset-error-message" class="text-red-600 text-sm text-center mt-2 hidden"></div>
                <div class="mt-5 sm:mt-6 sm:grid sm:grid-flow-row-dense sm:grid-cols-2 sm:gap-3">
                    <button type="submit" class="inline-flex w-full justify-center rounded-md border border-transparent bg-indigo-600 px-4 py-2 text-base font-medium text-white shadow-sm hover:bg-indigo-700 focus:outline-none sm:col-start-2 sm:text-sm">Enviar</button>
                    <button type="button" id="cancel-reset-button" class="mt-3 inline-flex w-full justify-center rounded-md border border-gray-300 bg-white px-4 py-2 text-base font-medium text-gray-700 shadow-sm hover:bg-gray-50 focus:outline-none sm:col-start-1 sm:mt-0 sm:text-sm">Cancelar</button>
                </div>
            </form>
        </div>
    </div>


    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getAuth, setPersistence, browserSessionPersistence, signInWithEmailAndPassword, onAuthStateChanged, signOut, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
        import { getFirestore, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "",
            authDomain: "romaneios-frigorifico-jau.firebaseapp.com",
            projectId: "",
            storageBucket: "",
            messagingSenderId: "",
            appId: "",
            measurementId: ""
        };
        const USER_DOMAIN = "";
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const loginScreen = document.getElementById('login-screen');
        const dashboardScreen = document.getElementById('dashboard-screen');
        const loginForm = document.getElementById('login-form');
        const errorMessage = document.getElementById('error-message');
        const forgotPasswordLink = document.getElementById('forgot-password-link');
        const resetPasswordModal = document.getElementById('reset-password-modal');
        const resetPasswordForm = document.getElementById('reset-password-form');
        const cancelResetButton = document.getElementById('cancel-reset-button');
        const resetErrorMessage = document.getElementById('reset-error-message');
        const logoutButton = document.getElementById('logout-button');
        const backButton = document.getElementById('back-button');
        const welcomeMessage = document.getElementById('welcome-message');
        const fileGroupsContainer = document.getElementById('file-groups-container');
        const loadingIndicator = document.getElementById('loading-indicator');
        const noFilesMessage = document.getElementById('no-files-message');

        loginForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const userInput = loginForm.username.value.trim();
            const password = loginForm.password.value;
            
            let email;
            if (userInput.includes('@')) {
                email = userInput.toLowerCase();
            } else {
                email = userInput.toLowerCase() + USER_DOMAIN;
            }

            setPersistence(auth, browserSessionPersistence)
                .then(() => {
                    return signInWithEmailAndPassword(auth, email, password);
                })
                .catch((error) => {
                    errorMessage.textContent = 'Usuário ou senha inválidos.';
                    errorMessage.classList.remove('hidden');
                    console.error("Erro de login:", error.message);
                });
        });

        forgotPasswordLink.addEventListener('click', (e) => {
            e.preventDefault();
            resetPasswordModal.classList.remove('hidden');
            resetPasswordForm.reset();
            resetErrorMessage.classList.add('hidden');
        });

        cancelResetButton.addEventListener('click', () => {
            resetPasswordModal.classList.add('hidden');
        });

        resetPasswordForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const userInput = document.getElementById('reset-email').value.trim();
            
            let email;
            if (userInput.includes('@')) {
                email = userInput.toLowerCase();
            } else {
                email = userInput.toLowerCase() + USER_DOMAIN;
            }

            sendPasswordResetEmail(auth, email)
                .then(() => {
                    resetPasswordModal.classList.add('hidden');
                    errorMessage.textContent = 'E-mail de redefinição enviado com sucesso! Verifique sua caixa de entrada.';
                    errorMessage.classList.remove('hidden');
                })
                .catch((error) => {
                    console.error("Erro ao enviar e-mail de redefinição:", error.code);
                    if (error.code === 'auth/user-not-found') {
                        resetErrorMessage.textContent = 'Usuário ou e-mail não encontrado.';
                    } else {
                        resetErrorMessage.textContent = 'Ocorreu um erro. Tente novamente.';
                    }
                    resetErrorMessage.classList.remove('hidden');
                });
        });

        logoutButton.addEventListener('click', () => signOut(auth));
        backButton.addEventListener('click', () => signOut(auth));
        onAuthStateChanged(auth, (user) => {
            if (user) {
                loginScreen.classList.add('hidden');
                dashboardScreen.classList.remove('hidden');
                fetchUserFiles(user);
            } else {
                loginScreen.classList.remove('hidden');
                dashboardScreen.classList.add('hidden');
                fileGroupsContainer.innerHTML = '';
            }
        });
        
        async function handleShare(userId, filePath, fileName) {
            const shareButton = document.querySelector(`button[data-filepath-share="${filePath}"]`);
            const originalButtonHTML = shareButton.innerHTML;
            shareButton.disabled = true;
            shareButton.innerHTML = `<svg class="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>`;

            try {
                const fileUrl = `/downloads/${filePath}?uid=${userId}`;
                const response = await fetch(fileUrl);
                if (!response.ok) throw new Error('Falha ao carregar o PDF.');
                
                const blob = await response.blob();
                const file = new File([blob], fileName, { type: 'application/pdf' });

                const shareData = {
                    files: [file],
                    title: fileName,
                    text: `Romaneio: ${fileName}`,
                };

                if (navigator.canShare && navigator.canShare(shareData)) {
                    await navigator.share(shareData);
                } else {
                    throw new Error('Partilha de ficheiros não suportada.');
                }
            } catch (error) {
                console.error('Erro ao partilhar:', error);
                alert('Não foi possível partilhar o ficheiro. Tente baixar e partilhar manualmente.');
            } finally {
                shareButton.disabled = false;
                shareButton.innerHTML = originalButtonHTML;
            }
        }
        window.handleShare = handleShare;

        async function fetchUserFiles(user) {
            loadingIndicator.classList.remove('hidden');
            noFilesMessage.classList.add('hidden');
            fileGroupsContainer.innerHTML = '';
            
            const isShareSupported = !!navigator.share;

            try {
                const q = query(collection(db, "arquivos"), where("clienteId", "==", user.uid));
                const querySnapshot = await getDocs(q);

                if (querySnapshot.empty) {
                    noFilesMessage.classList.remove('hidden');
                    welcomeMessage.textContent = `Bem-vindo(a)!`;
                    return;
                }
                
                const nomeCliente = querySnapshot.docs[0].data().nomeCliente;
                welcomeMessage.textContent = `Bem-vindo(a), ${nomeCliente}!`;

                const filesByCategory = {};
                querySnapshot.docs.forEach(doc => { const file = doc.data(); const category = file.categoria || 'Arquivos Principais'; if (!filesByCategory[category]) { filesByCategory[category] = []; } filesByCategory[category].push(file); });
                const sortedCategories = Object.keys(filesByCategory).sort();

                const createFileList = (files, userId) => {
                    const fileList = document.createElement('ul');
                    fileList.className = 'divide-y divide-gray-200 border-t border-gray-200';
                    files.sort((a, b) => b.dataDeUpload.toMillis() - a.dataDeUpload.toMillis());
                    
                    files.forEach(file => {
                        const uploadDate = file.dataDeUpload.toDate();
                        const formattedDate = uploadDate.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric' });
                        const listItem = document.createElement('li');

                        const filePath = file.categoria ? `${file.categoria}/${file.nomeDoArquivo}` : file.nomeDoArquivo;
                        const viewUrl = `/downloads/${filePath}?uid=${userId}`;
                        const downloadUrl = `/downloads/${filePath}?uid=${userId}&action=download`;

                        const shareButtonHTML = isShareSupported 
                            ? `<button data-filepath-share="${filePath}" onclick="window.handleShare('${userId}', '${filePath}', '${file.nomeDoArquivo}')" class="flex items-center justify-center rounded-md bg-green-600 px-3 py-1.5 text-sm font-medium text-white hover:bg-green-700 space-x-2">
                                   <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M13 4.5a2.5 2.5 0 11.755 4.513l-4.113 2.056a2.5 2.5 0 010 1.862l4.113 2.056A2.5 2.5 0 1113 15.5a2.5 2.5 0 01-.755-4.513L8.132 8.93A2.5 2.5 0 018.132 7.07l4.113-2.056A2.5 2.5 0 0113 4.5z" /></svg>
                                   <span>ENVIAR</span>
                               </button>`
                            : '';

                        listItem.innerHTML = `
                            <div class="px-4 py-4 sm:px-6 flex flex-col sm:flex-row items-start sm:items-center justify-between gap-3">
                                <a href="${viewUrl}" target="_blank" class="flex items-center truncate hover:underline">
                                    <svg class="h-6 w-6 text-gray-400 mr-3 flex-shrink-0" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m2.125 15L17.25 12m-7.5 0h7.5" /></svg>
                                    <p class="font-medium text-indigo-600 truncate">${file.nomeDoArquivo}</p>
                                </a>
                                <div class="w-full sm:w-auto flex-shrink-0 flex items-center justify-end space-x-2 sm:ml-4">
                                    <p class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">${formattedDate}</p>
                                    
                                    ${shareButtonHTML}

                                    <!-- Botão de Baixar -->
                                    <a href="${downloadUrl}" download="${file.nomeDoArquivo}" class="rounded-md bg-indigo-600 px-3 py-1.5 text-sm font-medium text-white hover:bg-indigo-700">Baixar</a>
                                </div>
                            </div>`;
                        fileList.appendChild(listItem);
                    });
                    return fileList;
                };

                if (filesByCategory['Arquivos Principais']) { const rootFilesList = createFileList(filesByCategory['Arquivos Principais'], user.uid); fileGroupsContainer.appendChild(rootFilesList); delete filesByCategory['Arquivos Principais']; }
                for (const category of sortedCategories) { if (!filesByCategory[category]) continue; const detailsElement = document.createElement('details'); detailsElement.className = 'group'; const summaryElement = document.createElement('summary'); summaryElement.className = 'p-4 flex items-center justify-between bg-gray-50 hover:bg-gray-100 border-t border-gray-200'; summaryElement.innerHTML = ` <div class="flex items-center"> <svg class="h-6 w-6 text-yellow-500 mr-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 12.75V12A2.25 2.25 0 014.5 9.75h15A2.25 2.25 0 0121.75 12v.75m-8.69-6.44l-2.12-2.12a1.5 1.5 0 00-1.061-.44H4.5A2.25 2.25 0 002.25 6v12a2.25 2.25 0 002.25 2.25h15A2.25 2.25 0 0021.75 18V9a2.25 2.25 0 00-2.25-2.25h-5.379a1.5 1.5 0 01-1.06-.44z" /></svg> <span class="font-medium text-gray-800">${category}</span> </div> <svg class="h-5 w-5 text-gray-500 transform transition-transform duration-200 group-open:rotate-90" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" /></svg> `; const filesForCategory = createFileList(filesByCategory[category], user.uid); detailsElement.appendChild(summaryElement); detailsElement.appendChild(filesForCategory); fileGroupsContainer.appendChild(detailsElement); }

            } catch (error) {
                console.error("ERRO AO BUSCAR ARQUIVOS NO FIRESTORE:", error);
                noFilesMessage.textContent = "Ocorreu um erro ao carregar seus arquivos. Verifique o console para mais detalhes.";
                noFilesMessage.classList.remove('hidden');
            } finally {
                loadingIndicator.classList.add('hidden');
            }
        }
    </script>

    <!-- Registo do Service Worker -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js').then(registration => {
                    console.log('ServiceWorker registration successful with scope: ', registration.scope);
                }, err => {
                    console.log('ServiceWorker registration failed: ', err);
                });
            });
        }
    </script>
</body>
</html>
